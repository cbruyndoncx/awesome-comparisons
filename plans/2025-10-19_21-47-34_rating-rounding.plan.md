# Plan: Ensure Ratings Display Cleanly

Round visible rating values to one decimal place and hide output entirely when ratings are unavailable so the UI never shows `NaN`.

## Tasks

- [x] Investigate current rating calculation and display handling for missing ratings
  > **Bash** `["bash","-lc","rg \"rating\" src -n"]`
  >
  > Found rating usage in `src/app/components/output/generic-table/generic-table.component.html:75`, `src/app/components/comparison/details/comparison.details.template.html:76`, exposing how missing ratings render.
  > ---
  > **Bash** `["bash","-lc","sed -n '1,160p' lib/gulp/model/data/criteriaData.js"]`
  >
  > Confirmed averaging logic divides by `this.labels.size` without guarding against zero, producing `NaN` ratings and lacking rounding.
  > ---
  > **Bash** `["bash","-lc","sed -n '60,100p' src/app/components/output/generic-table/generic-table.component.html"]`
  >
  > Verified template shows a star with any non-null rating and prints "Missing" otherwise, so blank output requires template adjustments.
  >
  > Investigation complete; `lib/gulp/model/data/criteriaData.js` identified as the calculation hot spot, with UI templates ready for follow-up edits.
- [x] Implement rounded rating calculation and UI display updates
  > **Edit** `apply_patch`
  > ```diff
  > *** Begin Patch
  > *** Update File: lib/gulp/model/data/label.js
  > @@
  > -          stars = parseInt(starsMatch, 10);
  > +          const parsedStars = parseInt(starsMatch, 10);
  > +          stars = Number.isFinite(parsedStars) ? parsedStars : 0;
  >           comment = (commentMatch || "").trim();
  > *** End Patch
  > ```
  > Added numeric guard so unrated entries default to zero stars instead of `NaN`.
  > ---
  > **Edit** `apply_patch`
  > ```diff
  > *** Begin Patch
  > *** Update File: lib/gulp/model/data/criteriaData.js
  > @@
  > -      let rating = 0;
  > -      this.labels.forEach((value, key) => {
  > -        rating += value.stars;
  > -      });
  > -      this.rating = rating / this.labels.size;
  > +      let ratingSum = 0;
  > +      let ratingCount = 0;
  > +      this.labels.forEach((value) => {
  > +        if (!isNullOrUndefined(value) && Number.isFinite(value.stars)) {
  > +          ratingSum += value.stars;
  > +          ratingCount++;
  > +        }
  > +      });
  > +      if (ratingCount > 0) {
  > +        const average = ratingSum / ratingCount;
  > +        this.rating = Math.round(average * 10) / 10;
  > +      }
  > *** End Patch
  > ```
  > Averaged only finite star values and rounded to one decimal place, leaving unrated criteria undefined.
  > ---
  > **Edit** `apply_patch`
  > ```diff
  > *** Begin Patch
  > *** Update File: src/app/components/output/generic-table/generic-table.component.html
  > @@
  > -                    <iicon icon="star" *ngIf="entry?.rating !== undefined && entry?.rating !== null">{{entry.rating}}
  > -                    </iicon>
  > -                    <span *ngIf="entry?.rating === undefined || entry?.rating === null">Missing</span>
  > +                    <iicon icon="star" *ngIf="entry?.rating !== undefined && entry?.rating !== null">{{entry.rating}}
  > +                    </iicon>
  > *** End Patch
  > ```
  > Removed the "Missing" fallback so absent ratings render as empty cells.
  > ---
  > **Edit** `apply_patch`
  > ```diff
  > *** Begin Patch
  > *** Update File: src/app/components/comparison/details/comparison.details.template.html
  > @@
  > -                <span *ngIf="types[i] === 'RATING' && (entry?.rating === undefined || entry?.rating === null)" class="missing-text">Missing</span>
  >             </div>
  > *** End Patch
  > ```
  > Cleared the detail view "Missing" label for unrated entries to align with the table output.
  > ---
  > Updates applied to [`lib/gulp/model/data/label.js`](../lib/gulp/model/data/label.js), [`lib/gulp/model/data/criteriaData.js`](../lib/gulp/model/data/criteriaData.js), [`src/app/components/output/generic-table/generic-table.component.html`](../src/app/components/output/generic-table/generic-table.component.html), and [`src/app/components/comparison/details/comparison.details.template.html`](../src/app/components/comparison/details/comparison.details.template.html).
- [x] Add regression coverage to prevent unrounded or `NaN` ratings from resurfacing
  > **Edit** `apply_patch`
  > ```diff
  > *** Begin Patch
  > *** Add File: lib/gulp/tests/criteria-data-rating.spec.mjs
  > +import assert from "node:assert";
  > +import { createRequire } from "node:module";
  > +
  > +globalThis.require = createRequire(new URL("../model/criteria/criteria.js", import.meta.url));
  > +
  > +const { CriteriaData } = await import("../model/data/criteriaData.js");
  > +const RATING_TYPE = "RATING";
  > +
  > +const buildRatingCriteria = (starsArray) => {
  > +    const labels = new Map(
  > +        starsArray.map((value, index) => [`label-${index}`, { stars: value }])
  > +    );
  > +    return new CriteriaData("Rating", "", labels, RATING_TYPE);
  > +};
  > +
  > +const roundedCriteria = buildRatingCriteria([4, 3]);
  > +assert.strictEqual(
  > +    roundedCriteria.rating,
  > +    3.5,
  > +    "Average rating should round to one decimal place"
  > +);
  > +
  > +const roundedUpCriteria = buildRatingCriteria([4, 3, 2, 2]);
  > +assert.strictEqual(
  > +    roundedUpCriteria.rating,
  > +    2.8,
  > +    "Average rating should round up at the second decimal place"
  > +);
  > +
  > +const zeroLabelsCriteria = buildRatingCriteria([]);
  > +assert.strictEqual(
  > +    zeroLabelsCriteria.rating,
  > +    undefined,
  > +    "Criteria with no ratings should not set a rating value"
  > +);
  > +
  > +const invalidStarsCriteria = buildRatingCriteria([Number.NaN]);
  > +assert.strictEqual(
  > +    invalidStarsCriteria.rating,
  > +    undefined,
  > +    "Invalid star values should be ignored, resulting in no rating"
  > +);
  > +
  > +console.log("criteriaData rating tests passed.");
  > *** End Patch
  > ```
  > Added a dedicated Node test to verify rounding, rounding-up, and empty/invalid-rating scenarios.
  > ---
  > **Edit** `apply_patch`
  > ```diff
  > *** Begin Patch
  > *** Update File: lib/gulp/tests/criteria-data-rating.spec.mjs
  > @@
  > -import assert from "node:assert";
  > -
  > -import { CriteriaData } from "../model/data/criteriaData.js";
  > -
  > -const RATING_TYPE = "RATING";
  > +import assert from "node:assert";
  > +import { createRequire } from "node:module";
  > +
  > +globalThis.require = createRequire(new URL("../model/criteria/criteria.js", import.meta.url));
  > +
  > +const { CriteriaData } = await import("../model/data/criteriaData.js");
  > +const RATING_TYPE = "RATING";
  > *** End Patch
  > ```
  > Ensured the test runs under Node's ESM loader by wiring a scoped `require` fallback before importing the model.
  > ---
  > **Bash** `["bash","-lc","node lib/gulp/tests/criteria-data-rating.spec.mjs"]`
  >
  > Executed the new regression test; it passed with the existing typeless package warning noted in previous builds.
  > ---
  > Regression coverage added at [`lib/gulp/tests/criteria-data-rating.spec.mjs`](../lib/gulp/tests/criteria-data-rating.spec.mjs).
