# Plan: Split md2json Specs

Separate the combined md2json spec into two Tessl specs (converter core + CLI) so each `@generate` file has a dedicated source of truth.

## Tasks

- [x] Review the current combined spec to determine which requirements belong to the Md2Json class vs. the CLI.
  > **Bash** `{"command":["bash","-lc","cat specs/lib/md2json/md2json.spec.md"],"workdir":"/home/cb/projects/github/ultimate/ultimate-comparison-framework"}`
  >
  > Read the existing combined spec [specs/lib/md2json/md2json.spec.md](../specs/lib/md2json/md2json.spec.md) to separate converter-specific requirements (markdown parsing, JSON nodes, file IO) from CLI requirements (argument parsing, error messages).
- [x] Create a new CLI-focused spec and adjust the existing spec to cover only the Md2Json converter.
  > **Edit** `apply_patch`
  > ```
  > *** Begin Patch
  > *** Update File: specs/lib/md2json/md2json.spec.md
  > @@
  > -## Target
  > -
  > -[@generate](../../../lib/md2json/md2json.ts)
  > -[@generate](../../../lib/md2json/cli.ts)
  > +## Target
  > +
  > +[@generate](../../../lib/md2json/md2json.ts)
  > @@
  > -### Parse command line arguments
  > -
  > -Accepts both modern flag-based arguments and legacy positional arguments for backward compatibility.
  > -
  > -- Supports `--input`, `--tmp`, `--output`, `--level`, and `--pretty` flags
  > -- Falls back to positional arguments `input tmp output [level] [pretty]`
  > -- Rejects missing required paths with helpful error message and non-zero exit code
  > -- Validates that input and tmp directories exist or can be created
  > -
  > -### Convert markdown files to JSON format
  > +### Convert markdown files to JSON format
  > @@
  > -### Error handling and logging
  > +### Persist converter configuration
  > +
  > +Stores runtime options required by higher-level tooling.
  > +
  > +- Accepts `level` (default 2) and `pretty` (default false) when the class is constructed
  > +- Exposes these options to downstream operations so gulp scripts can inspect behavior in the future
  > +
  > +### Error handling and logging
  > @@
  > -export class Md2Json {
  > -  constructor(options: { level?: number; pretty?: boolean });
  > -
  > -  convertMarkdownToJson(markdown: string): HeaderNode | null;
  > -  dirToJson(inputDir: string, tmpDir: string, outputPath: string): Promise<void>;
  > -}
  > -
  > -export function main(argv: string[]): Promise<void>;
  > +export class Md2Json {
  > +  constructor(options?: { level?: number; pretty?: boolean });
  > +
  > +  convertMarkdownToJson(markdown: string): HeaderNode | null;
  > +  dirToJson(inputDir: string, tmpDir: string, outputPath: string): Promise<void>;
  > +}
  > @@
  > -### Argument parsing
  > -
  > -For handling command line flags and positional arguments.
  > -[@use](minimist)
  > *** End Patch
  > ```
  >
  > Limited the original spec to the converter behavior only, removing CLI coverage and emphasizing converter configuration storage.
  > ---
  > **Edit** `apply_patch`
  > ```
  > *** Begin Patch
  > *** Add File: specs/lib/md2json/md2json-cli.spec.md
  > +# Md2Json CLI
  > +
  > +Node entry point that wires command line arguments into the Md2Json converter.
  > +
  > +## Target
  > +
  > +[@generate](../../../lib/md2json/cli.ts)
  > +
  > +## Capabilities
  > +
  > +### Parse CLI arguments
  > +
  > +Provide both modern flag support and the legacy positional fallbacks expected by existing gulp scripts.
  > +
  > +- Accepts `--input`, `--tmp`, `--output`, `--level`, and `--pretty`
  > +- Falls back to positional arguments `input tmp output [level] [pretty]` when flags are not supplied
  > +- Validates that required paths are present; prints usage guidance and exits non-zero if they are missing
  > +- Coerces `level` to a number (defaults to 2) and `pretty` to a boolean (`true`, `1`, `yes`)
  > +
  > +### Integrate with Md2Json
  > +
  > +Instantiates the generated `Md2Json` class and delegates conversion work.
  > +
  > +- Passes `level` and `pretty` into the class constructor
  > +- Calls `dirToJson(inputDir, tmpDir, outputPath)` and awaits the returned promise
  > +- Surfaces stdout/stderr exactly once so gulp can capture logs in `tmp/error.log`
  > +
  > +### Error handling and exit codes
  > +
  > +- On recoverable argument errors, print a helpful message and exit with status `1`
  > +- On converter failures (rejected promise, thrown error), print the error message to stderr and exit `1`
  > +- On success, exit with `0`
  > +
  > +## API
  > +
  > +```typescript { .api }
  > +export async function main(argv: string[]): Promise<void>;
  > +```
  > +
  > +## Dependencies
  > +
  > +### Argument parsing
  > +
  > +[@use](minimist)
  > +
  > +### Converter integration
  > +
  > +[@use](./md2json)
  > *** End Patch
  > ```
  >
  > Added a dedicated CLI spec to capture argument parsing, delegation, and error-handling requirements tied to `lib/md2json/cli.ts`.
- [x] Run Tessl builds for the new specs to confirm both code files are linked to single-spec sources.
  > **MCP** `tessl - build`
  > - spec: ["specs/lib/md2json/md2json.spec.md","specs/lib/md2json/md2json-cli.spec.md"]
  >
  > Rebuilt both specs so the converter and CLI files were regenerated under their single respective specs.
  > ---
  > **MCP** `tessl - status`
  > - spec: specs/lib/md2json/md2json.spec.md
  >
  > Verified the converter spec now has only the missing-test warning (acceptable for this change).
  > ---
  > **MCP** `tessl - status`
  > - spec: specs/lib/md2json/md2json-cli.spec.md
  >
  > Initial CLI status surfaced a dependency resolution error due to the `@use` reference pointing at a non-spec path.
  > ---
  > **Edit** `apply_patch`
  > ```
  > *** Begin Patch
  > *** Update File: specs/lib/md2json/md2json-cli.spec.md
  > @@
  >  ### Converter integration
  >  
  >  Uses the `Md2Json` class defined by the sibling converter spec.
  > -
  > -### Converter integration
  > -
  > -[@use](./md2json)
  > +### Converter integration
  > +
  > +Uses the `Md2Json` class defined by the sibling converter spec.
  > *** End Patch
  > ```
  >
  > Removed the problematic `@use` reference so the CLI spec no longer points to a missing spec file.
  > ---
  > **MCP** `tessl - build`
  > - spec: ["specs/lib/md2json/md2json-cli.spec.md"]
  >
  > Rebuilt the CLI spec but dependency verification failed because `@types/node` was not declared.
  > ---
  > **Edit** `apply_patch`
  > ```
  > *** Begin Patch
  > *** Update File: specs/lib/md2json/md2json-cli.spec.md
  > @@
  >  ### Converter integration
  >  
  >  Uses the `Md2Json` class defined by the sibling converter spec.
  > +
  > +### Node typings
  > +
  > +[@use](@types/node)
  > *** End Patch
  > ```
  >
  > Declared the Node typings dependency so Tessl recognizes the CLIâ€™s reliance on `process`.
  > ---
  > **MCP** `tessl - build`
  > - spec: ["specs/lib/md2json/md2json-cli.spec.md"]
  >
  > Regenerated the CLI code successfully with dependency verification passing, leaving only the expected missing-test warnings on both specs.
  > ---
  > **MCP** `tessl - status`
  > - spec: specs/lib/md2json/md2json-cli.spec.md
  >
  > Confirmed the final CLI spec state now only reports the missing-test warning.
