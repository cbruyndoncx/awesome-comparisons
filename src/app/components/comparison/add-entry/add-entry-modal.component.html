<div class="add-entry-modal">
  <div class="modal-header">
    <h2 mat-dialog-title>Add New Entry to {{ data.dataset.displayLabel }}</h2>
    <button type="button" class="close-button" (click)="close()" aria-label="Close">
      Ã—
    </button>
  </div>

  <mat-dialog-content class="modal-content">
    <div class="content-layout">
      <!-- Form Section -->
      <div class="form-section" [class.hidden]="showPreview">
        <form [formGroup]="entryForm">
          <!-- Basic Info -->
          <div class="section basic-info">
            <h3 class="section-title">Basic Information</h3>

            <div class="form-group">
              <label for="entry-name">Name *</label>
              <input
                id="entry-name"
                type="text"
                formControlName="_name"
                placeholder="e.g., Cursor IDE"
                class="form-control"
                />
            </div>

            <div class="form-group">
              <label for="entry-url">URL *</label>
              <input
                id="entry-url"
                type="url"
                formControlName="_url"
                placeholder="https://example.com"
                class="form-control"
                />
            </div>

            <div class="form-group">
              <label for="entry-description">Description</label>
              <textarea
                id="entry-description"
                formControlName="_description"
                placeholder="Brief description of the product..."
                class="form-control"
                rows="3"
              ></textarea>
            </div>
          </div>

          <!-- Feature Groups -->
          @for (group of data.featureGroups; track group) {
            <div class="section feature-group">
              <h3 class="section-title">{{ group.displayName || group.key }}</h3>
              @for (criteriaControl of groupedCriteria.get(group.displayName || group.key); track criteriaControl) {
                <div class="criteria-item">
                  @switch (criteriaControl.criteria.type) {
                    <!-- LABEL Type -->
                    @case (CriteriaTypes.LABEL) {
                      <div class="criteria-label">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <div class="label-options">
                          @for (labelValue of getLabelValues(criteriaControl.criteria); track labelValue) {
                            <button
                              type="button"
                              class="label-chip"
                              [class.selected]="isLabelSelected(criteriaControl.criteria.id, labelValue)"
                              (click)="toggleLabel(criteriaControl.criteria.id, labelValue)"
                              >
                              {{ labelValue }}
                            </button>
                          }
                        </div>
                      </div>
                    }
                    <!-- TEXT Type -->
                    @case (CriteriaTypes.TEXT) {
                      <div class="criteria-text">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <input
                          type="text"
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          [placeholder]="criteriaControl.criteria.placeholder || 'Enter value...'"
                          class="form-control"
                          />
                      </div>
                    }
                    <!-- MARKDOWN Type -->
                    @case (CriteriaTypes.MARKDOWN) {
                      <div class="criteria-markdown">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <textarea
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          [placeholder]="criteriaControl.criteria.placeholder || 'Enter markdown content...'"
                          class="form-control"
                          rows="4"
                        ></textarea>
                      </div>
                    }
                    <!-- RATING Type -->
                    @case (CriteriaTypes.RATING) {
                      <div class="criteria-rating">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <input
                          type="text"
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          placeholder="e.g., [4] Excellent features"
                          class="form-control"
                          />
                      </div>
                    }
                    <!-- REPOSITORY Type -->
                    @case (CriteriaTypes.REPOSITORY) {
                      <div class="criteria-repository">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <input
                          type="url"
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          placeholder="https://github.com/..."
                          class="form-control"
                          />
                      </div>
                    }
                    <!-- Default/Fallback -->
                    @default {
                      <div class="criteria-default">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <input
                          type="text"
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          [placeholder]="criteriaControl.criteria.placeholder || 'Enter value...'"
                          class="form-control"
                          />
                      </div>
                    }
                  }
                </div>
              }
            </div>
          }

          <!-- Ungrouped Criteria -->
          @if (ungroupedCriteria.length > 0) {
            <div class="section feature-group">
              <h3 class="section-title">Additional Information</h3>
              @for (criteriaControl of ungroupedCriteria; track criteriaControl) {
                <div class="criteria-item">
                  @switch (criteriaControl.criteria.type) {
                    <!-- LABEL Type -->
                    @case (CriteriaTypes.LABEL) {
                      <div class="criteria-label">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <div class="label-options">
                          @for (labelValue of getLabelValues(criteriaControl.criteria); track labelValue) {
                            <button
                              type="button"
                              class="label-chip"
                              [class.selected]="isLabelSelected(criteriaControl.criteria.id, labelValue)"
                              (click)="toggleLabel(criteriaControl.criteria.id, labelValue)"
                              >
                              {{ labelValue }}
                            </button>
                          }
                        </div>
                      </div>
                    }
                    <!-- TEXT Type -->
                    @case (CriteriaTypes.TEXT) {
                      <div class="criteria-text">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <input
                          type="text"
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          [placeholder]="criteriaControl.criteria.placeholder || 'Enter value...'"
                          class="form-control"
                          />
                      </div>
                    }
                    <!-- MARKDOWN Type -->
                    @case (CriteriaTypes.MARKDOWN) {
                      <div class="criteria-markdown">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <textarea
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          [placeholder]="criteriaControl.criteria.placeholder || 'Enter markdown content...'"
                          class="form-control"
                          rows="4"
                        ></textarea>
                      </div>
                    }
                    <!-- RATING Type -->
                    @case (CriteriaTypes.RATING) {
                      <div class="criteria-rating">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <input
                          type="text"
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          placeholder="e.g., [4] Excellent features"
                          class="form-control"
                          />
                      </div>
                    }
                    <!-- REPOSITORY Type -->
                    @case (CriteriaTypes.REPOSITORY) {
                      <div class="criteria-repository">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <input
                          type="url"
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          placeholder="https://github.com/..."
                          class="form-control"
                          />
                      </div>
                    }
                    <!-- Default/Fallback -->
                    @default {
                      <div class="criteria-default">
                        <label class="criteria-name">{{ criteriaControl.criteria.name }}</label>
                        @if (criteriaControl.criteria.description) {
                          <p class="criteria-description">
                            {{ criteriaControl.criteria.description }}
                          </p>
                        }
                        <input
                          type="text"
                          [formControlName]="getFormControlName(criteriaControl.criteria.id)"
                          [placeholder]="criteriaControl.criteria.placeholder || 'Enter value...'"
                          class="form-control"
                          />
                      </div>
                    }
                  }
                </div>
              }
            </div>
          }
        </form>
      </div>

      <!-- Preview Section -->
      <div class="preview-section" [class.hidden]="!showPreview">
        <div class="preview-header">
          <h3>Markdown Preview</h3>
          <p class="preview-filename">Filename: <code>{{ filename }}</code></p>
        </div>
        <pre class="markdown-preview">{{ markdownPreview }}</pre>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions class="modal-actions">
    <div class="actions-left">
      <button type="button" class="btn btn-secondary" (click)="togglePreview()">
        {{ showPreview ? 'Show Form' : 'Show Preview' }}
      </button>
    </div>

    <div class="actions-right">
      <button type="button" class="btn btn-secondary" (click)="downloadMarkdown()">
        Download .md
      </button>
      <button type="button" class="btn btn-secondary" (click)="copyToClipboard()">
        Copy
      </button>
      <button type="button" class="btn btn-primary" (click)="submitToGitHub()">
        Submit to GitHub
      </button>
    </div>
  </mat-dialog-actions>
</div>
