<ng-container *ngIf="groups$ | async as groups">
    <div class="group-controls" *ngIf="groups.length > 0">
        <div class="group-controls__header">
            <div class="group-controls__title">Show/hide column groups:</div>
            <div class="group-controls__buttons">
                <button type="button"
                        class="group-controls__toggle"
                        (click)="viewModeChange.emit(viewMode === 'sheet' ? 'table' : 'sheet')"
                        [attr.aria-pressed]="viewMode === 'sheet'"
                        [attr.title]="viewMode === 'sheet' ? 'Switch to standard table view' : 'Switch to focused sheet view'">
                    <iicon icon="view-column"></iicon>
                    <span class="sr-only">{{ viewMode === 'sheet' ? 'Standard view' : 'Focused sheet view' }}</span>
                </button>
                <button type="button"
                        class="group-controls__toggle"
                        (click)="toggleExpand.emit(!tableExpanded)"
                        [attr.aria-pressed]="tableExpanded"
                        [attr.title]="tableExpanded ? 'Collapse table view' : 'Expand table view'">
                    <iicon [icon]="tableExpanded ? 'resize-small' : 'resize-full'"></iicon>
                    <span class="sr-only">{{ tableExpanded ? 'Collapse table view' : 'Expand table view' }}</span>
                </button>
            </div>
        </div>
        <div class="group-controls__list">
            <ptooltip *ngFor="let group of groups; trackBy: trackGroup"
                      [tooltip]="describeGroupCriteria(group)"
                      [position]="'s'">
                <button type="button"
                        class="group-control"
                        [class.group-control--expanded]="group.isExpanded"
                        [class.group-control--excluded]="group.isExcluded"
                        [disabled]="group.isExcluded"
                        [attr.aria-expanded]="group.isExpanded"
                        (click)="toggleGroup(group)">
                    <span class="group-name">{{group.displayName}}</span>
                    <span class="group-indicator" aria-hidden="true">{{groupIndicator(group)}}</span>
                    <span class="sr-only">
                        {{ group.isExcluded ? 'Unavailable' : (group.isExpanded ? 'Collapse' : 'Expand') }}
                    </span>
                </button>
            </ptooltip>
        </div>
    </div>
</ng-container>

<div class="group-panel">
    <div class="group-panel__table">
        <table class="table-hover">
            <thead>
            <ng-container *ngIf="visibleCriteriaMap$ | async as visibleCriteria">
                <tr>
                    <ng-template ngFor let-column [ngForOf]="columns" let-i="index">
                        <th>
                            <ng-container *ngIf="getColumnDescription(visibleCriteria, getColumnKey(i)) as columnDescription; else plainHeaderButton">
                                <ptooltip class="table-header-tooltip"
                                          [tooltip]="columnDescription"
                                          [position]="'s'">
                                    <button (click)="orderClick($event, i)">
                                        <iicon icon="keyboard-arrow-up" *ngIf="order[i]===-1; else elseif1">{{column}}</iicon>
                                        <ng-template #elseif1>
                                            <iicon icon="keyboard-arrow-down" *ngIf="order[i]===1; else elseif2">{{column}}</iicon>
                                        </ng-template>
                                        <ng-template #elseif2>
                                            <iicon>{{column}}</iicon>
                                        </ng-template>
                                    </button>
                                </ptooltip>
                            </ng-container>
                            <ng-template #plainHeaderButton>
                                <button (click)="orderClick($event, i)">
                                    <iicon icon="keyboard-arrow-up" *ngIf="order[i]===-1; else elseif1">{{column}}</iicon>
                                    <ng-template #elseif1>
                                        <iicon icon="keyboard-arrow-down" *ngIf="order[i]===1; else elseif2">{{column}}</iicon>
                                    </ng-template>
                                    <ng-template #elseif2>
                                        <iicon>{{column}}</iicon>
                                    </ng-template>
                                </button>
                            </ng-template>
                        </th>
                    </ng-template>
                    <th name="details" width="60px">
                        <div class="row-actions__header">
                            <picon-button class="row-actions__icon" icon="file_download" [showTooltip]="false" title="Download XLSX" aria-label="Download XLSX"
                                          (click)="xlsxDownload.emit({ columns: columns, columnKeys: columnKeys, items: items, index: index, types: types, dataElements: dataElements })"></picon-button>
                            <picon-button class="row-actions__icon" icon="settings" [showTooltip]="false" title="Settings" aria-label="Settings"
                                          (click)="settingsCallback.emit()"></picon-button>
                        </div>
                    </th>
                </tr>
            </ng-container>
            </thead>
            <tbody>
            <ng-template ngFor let-item [ngForOf]="items" let-itemIndex="index">
                <tr>
                    <ng-template ngFor let-entry [ngForOf]="item" let-i="index">
                        <td *ngIf="types[i] === 'NAME_URL'">
                            <a class="anchored"
                               [href]="entry?.link || entry?.url || '#'"
                               target="_blank"
                               rel="noopener noreferrer">
                                {{entry?.text || 'â€”'}}
                            </a>
                        </td>
                        <td *ngIf="types[i] === 'TEXT'">
                            {{entry?.tableText || entry?.summaryText || entry?.text || entry?.content}}
                        </td>
                        <td *ngIf="types[i] ===  'LABEL' || types[i] === 'REPOSITORY'"
                            class="label-cell"
                            [class.label-cell--label]="types[i] === 'LABEL'"
                            [class.label-cell--repository]="types[i] === 'REPOSITORY'"
                            [class.label-cell--colored]="types[i] === 'LABEL' && hasLabelFill(entry)"
                            [style.background]="types[i] === 'LABEL' ? resolveLabelCellFill(entry) : null">
                            <ng-container *ngIf="entry?.labelArray?.length; else missingLabelBlock">
                                <ng-container *ngFor="let label of entry?.labelArray">
                                    <ng-container *ngIf="label.tooltip?.text || label.tooltip?.html; else plainLabel">
                                        <ptooltip [tooltip]="label.tooltip.text"
                                                  [tooltipHtml]="label.tooltip.html" [position]="'n'">
                                            <div class="label mylabel {{label.clazz}}" [class.label--plain]="!labelColorsEnabled"
                                                 [style.color]="labelColorsEnabled ? label.color : null"
                                                 [style.background-color]="labelColorsEnabled ? label.backgroundColor : null"
                                                 (click)="labelClick($event, label, i)">
                                                <ng-container *ngIf="label.displayHtml; else labelDisplayTextTooltip">
                                                    <span [innerHtml]="label.displayHtml | sanitizeHtml"></span>
                                                </ng-container>
                                                <ng-template #labelDisplayTextTooltip>
                                                    {{labelDisplay(label)}}
                                                </ng-template>
                                            </div>
                                        </ptooltip>
                                    </ng-container>
                                    <ng-template #plainLabel>
                                        <div class="label mylabel {{label.clazz}}" [class.label--plain]="!labelColorsEnabled"
                                             [style.color]="labelColorsEnabled ? label.color : null"
                                             [style.background-color]="labelColorsEnabled ? label.backgroundColor : null"
                                             (click)="labelClick($event, label, i)">
                                            <ng-container *ngIf="label.displayHtml; else labelDisplayTextPlain">
                                                <span [innerHtml]="label.displayHtml | sanitizeHtml"></span>
                                            </ng-container>
                                            <ng-template #labelDisplayTextPlain>
                                                {{labelDisplay(label)}}
                                            </ng-template>
                                        </div>
                                    </ng-template>
                                </ng-container>
                            </ng-container>
                            <ng-template #missingLabelBlock>
                                <div *ngIf="showMissingIndicators" class="label mylabel label--missing">Missing</div>
                            </ng-template>
                            <div class="repository-links" *ngIf="entry?.type === 'REPOSITORY' && entry?.urlList?.length">
                                <a *ngFor="let link of entry.urlList" [href]="link" target="_blank" rel="noopener noreferrer">{{link}}</a>
                            </div>
                        </td>

                        <td *ngIf="types[i] === 'MARKDOWN'" class="markdown-cell"
                            [class.markdown-cell--expanded]="isMarkdownExpanded(itemIndex, i)">
                            <ng-template #markdownContent>
                                <ng-container *ngIf="entry?.tableText; else markdownHtml">
                                    {{entry?.tableText}}
                                </ng-container>
                            </ng-template>
                            <div class="markdown-cell__content"
                                 [class.markdown-cell__content--clamped]="shouldTruncateMarkdown(entry) && !isMarkdownExpanded(itemIndex, i)">
                                <ng-container *ngTemplateOutlet="markdownContent"></ng-container>
                            </div>
                            <button type="button"
                                    class="markdown-cell__toggle"
                                    *ngIf="shouldTruncateMarkdown(entry)"
                                    (click)="toggleMarkdownExpansion(itemIndex, i)"
                                    [attr.aria-expanded]="isMarkdownExpanded(itemIndex, i)">
                                {{isMarkdownExpanded(itemIndex, i) ? 'Show less' : 'Show more'}}
                            </button>
                            <ng-template #markdownHtml>
                                <div [innerHtml]="entry?.html | sanitizeHtml"></div>
                            </ng-template>
                        </td>
                        <td *ngIf="types[i] === 'RATING'">
                            <iicon icon="star" *ngIf="entry?.rating !== undefined && entry?.rating !== null">{{entry.rating}}
                            </iicon>
                        </td>
                    </ng-template>
                    <td class="row-actions">
                        <ng-container *ngIf="resolveEditLink(getRowIndex(itemIndex)) as editLink; else noEdit">
                            <a class="row-actions__link"
                               [href]="editLink"
                               target="_blank"
                               rel="noopener noreferrer"
                               title="Edit source"
                               aria-label="Edit source">
                                <picon-button icon="edit" [showTooltip]="false"></picon-button>
                            </a>
                        </ng-container>
                        <ng-template #noEdit>
                            <picon-button icon="edit" [showTooltip]="false" title="Edit source" (click)="openEdit(itemIndex)"></picon-button>
                        </ng-template>
                        <picon-button icon="info" [showTooltip]="false" title="Details"
                                      (click)="showDetails.emit(index[itemIndex])"></picon-button>
                    </td>
                </tr>
            </ng-template>
            </tbody>
        </table>
    </div>
</div>
