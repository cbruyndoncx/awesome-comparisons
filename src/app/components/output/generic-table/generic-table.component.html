<div class="group-panel">
    <ng-container *ngIf="groups$ | async as groups">
        <div class="group-controls" *ngIf="groups.length > 0">
            <div class="group-controls__header">
                <div class="group-controls__title">Show/hide column groups:</div>
                <button type="button"
                        class="group-controls__toggle"
                        (click)="toggleExpand.emit(!tableExpanded)"
                        [attr.aria-pressed]="tableExpanded">
                    <iicon [icon]="tableExpanded ? 'resize-small' : 'resize-full'"></iicon>
                    <span class="sr-only">{{ tableExpanded ? 'Collapse table view' : 'Expand table view' }}</span>
                </button>
            </div>
            <div class="group-controls__list">
                <button type="button"
                        class="group-control"
                        *ngFor="let group of groups; trackBy: trackGroup"
                        [class.group-control--expanded]="group.isExpanded"
                        [class.group-control--excluded]="group.isExcluded"
                        [disabled]="group.isExcluded"
                        [attr.aria-expanded]="group.isExpanded"
                        (click)="toggleGroup(group)">
                    <span class="group-name">{{group.displayName}}</span>
                    <span class="group-indicator" aria-hidden="true">{{groupIndicator(group)}}</span>
                    <span class="sr-only">
                        {{ group.isExcluded ? 'Unavailable' : (group.isExpanded ? 'Collapse' : 'Expand') }}
                    </span>
                </button>
            </div>
        </div>
    </ng-container>

    <div class="group-panel__table">
        <table class="table-hover">
            <thead>
            <tr>
                <ng-template ngFor let-column [ngForOf]="columns" let-i="index">
                    <th>
                        <button (click)="orderClick($event, i)">
                            <iicon icon="keyboard-arrow-up" *ngIf="order[i]===-1; else elseif1">{{column}}</iicon>
                            <ng-template #elseif1>
                                <iicon icon="keyboard-arrow-down" *ngIf="order[i]===1; else elseif2">{{column}}</iicon>
                            </ng-template>
                            <ng-template #elseif2>
                                <iicon>{{column}}</iicon>
                            </ng-template>
                        </button>
                    </th>
                </ng-template>
                <th name="details" width="30px">
                    <picon-button icon="settings" [showTooltip]="false" title="Settings"
                                  (click)="settingsCallback.emit()"></picon-button>
                </th>
            </tr>
            </thead>
            <tbody>
            <ng-template ngFor let-item [ngForOf]="items" let-itemIndex="index">
                <tr>
                    <ng-template ngFor let-entry [ngForOf]="item" let-i="index">
                        <td *ngIf="types[i] === 'NAME_URL'">
                            <a class="anchored"
                               [href]="entry?.link || entry?.url || '#'"
                               target="_blank"
                               rel="noopener noreferrer">
                                {{entry?.text || 'â€”'}}
                            </a>
                        </td>
                        <td *ngIf="types[i] === 'TEXT'">
                            {{entry?.tableText || entry?.summaryText || entry?.text || entry?.content}}
                        </td>
                        <td *ngIf="types[i] ===  'LABEL' || types[i] === 'REPOSITORY'"
                            class="label-cell"
                            [class.label-cell--colored]="types[i] === 'LABEL' && hasLabelFill(entry)"
                            [style.background]="types[i] === 'LABEL' ? resolveLabelCellFill(entry) : null">
                            <ng-container *ngIf="entry?.labelArray?.length; else missingLabelBlock">
                                <ng-container *ngFor="let label of entry?.labelArray">
                                    <ng-container *ngIf="label.tooltip?.text || label.tooltip?.html; else plainLabel">
                                        <ptooltip [tooltip]="label.tooltip.text"
                                                  [tooltipHtml]="label.tooltip.html" [position]="'n'">
                                            <div class="label mylabel {{label.clazz}}" [class.label--plain]="!labelColorsEnabled"
                                                 [style.color]="labelColorsEnabled ? label.color : null"
                                                 [style.background-color]="labelColorsEnabled ? label.backgroundColor : null"
                                                 (click)="labelClick($event, label, i)">
                                                <ng-container *ngIf="label.displayHtml; else labelDisplayTextTooltip">
                                                    <span [innerHtml]="label.displayHtml | sanitizeHtml"></span>
                                                </ng-container>
                                                <ng-template #labelDisplayTextTooltip>
                                                    {{labelDisplay(label)}}
                                                </ng-template>
                                            </div>
                                        </ptooltip>
                                    </ng-container>
                                    <ng-template #plainLabel>
                                        <div class="label mylabel {{label.clazz}}" [class.label--plain]="!labelColorsEnabled"
                                             [style.color]="labelColorsEnabled ? label.color : null"
                                             [style.background-color]="labelColorsEnabled ? label.backgroundColor : null"
                                             (click)="labelClick($event, label, i)">
                                            <ng-container *ngIf="label.displayHtml; else labelDisplayTextPlain">
                                                <span [innerHtml]="label.displayHtml | sanitizeHtml"></span>
                                            </ng-container>
                                            <ng-template #labelDisplayTextPlain>
                                                {{labelDisplay(label)}}
                                            </ng-template>
                                        </div>
                                    </ng-template>
                                </ng-container>
                            </ng-container>
                            <ng-template #missingLabelBlock>
                                <div class="label mylabel label--missing">Missing</div>
                            </ng-template>
                            <div class="repository-links" *ngIf="entry?.type === 'REPOSITORY' && entry?.urlList?.length">
                                <a *ngFor="let link of entry.urlList" [href]="link" target="_blank" rel="noopener noreferrer">{{link}}</a>
                            </div>
                        </td>

                        <td *ngIf="types[i] === 'MARKDOWN'">
                            <ng-container *ngIf="entry?.tableText; else markdownHtml">
                                {{entry?.tableText}}
                            </ng-container>
                            <ng-template #markdownHtml>
                                <div [innerHtml]="entry?.html | sanitizeHtml"></div>
                            </ng-template>
                        </td>
                        <td *ngIf="types[i] === 'RATING'">
                            <iicon icon="star" *ngIf="entry?.rating !== undefined && entry?.rating !== null">{{entry.rating}}
                            </iicon>
                        </td>
                    </ng-template>
                    <td class="row-actions">
                        <a *ngIf="resolveEditLink(index[itemIndex]) as editLink"
                           class="row-actions__link"
                           [href]="editLink"
                           target="_blank"
                           rel="noopener noreferrer"
                           title="Edit source"
                           aria-label="Edit source">
                            <picon-button icon="edit" [showTooltip]="false"></picon-button>
                        </a>
                        <picon-button icon="info" [showTooltip]="false" title="Details"
                                      (click)="showDetails.emit(index[itemIndex])"></picon-button>
                    </td>
                </tr>
            </ng-template>
            </tbody>
        </table>
    </div>
</div>
